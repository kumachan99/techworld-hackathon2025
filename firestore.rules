rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    // =========================================================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // =========================================================================
    // é–‹ç™ºç”¨: å…¨ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«å¯¾ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯
    // âš ï¸ æœ¬ç•ªç’°å¢ƒã§ã¯å¿…ãšå‰Šé™¤ã™ã‚‹ã“ã¨ï¼
    // =========================================================================
    match /{document=**} {
      allow read, write: if true;
    }

    // =========================================================================
    // master_policiesï¼ˆæ”¿ç­–ã‚«ãƒ¼ãƒ‰ãƒã‚¹ã‚¿ãƒ¼ï¼‰
    // =========================================================================
    match /master_policies/{policyId} {
      allow read: if isAuthenticated();
      allow write: if false;  // Admin SDK ã®ã¿
    }

    // =========================================================================
    // master_ideologiesï¼ˆæ€æƒ³ãƒã‚¹ã‚¿ãƒ¼ï¼‰
    // =========================================================================
    match /master_ideologies/{ideologyId} {
      allow read: if isAuthenticated();
      allow write: if false;  // Admin SDK ã®ã¿
    }

    // =========================================================================
    // roomsï¼ˆã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ ï¼‰
    // =========================================================================
    match /rooms/{roomId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();  // ãƒãƒƒã‚«ã‚½ãƒ³ç”¨ã«ç·©å’Œ
      allow delete: if false;

      // -----------------------------------------------------------------------
      // players ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
      // -----------------------------------------------------------------------
      match /players/{userId} {
        // ğŸŒ å…¬é–‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿èª­ã¿å–ã‚Šå¯èƒ½
        // âš ï¸ æ³¨æ„: Firestore ã¯ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ¬ãƒ™ãƒ«ã®èª­ã¿å–ã‚Šåˆ¶å¾¡ãŒã§ããªã„ãŸã‚ã€
        //    æœ¬ç•ªç’°å¢ƒã§ã¯ Cloud Functions çµŒç”±ã§ç§˜åŒ¿ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’é™¤å¤–ã—ã¦è¿”ã™å¿…è¦ãŒã‚ã‚‹
        //
        // ãƒãƒƒã‚«ã‚½ãƒ³ç”¨ã®ç°¡æ˜“å®Ÿè£…:
        // - èª­ã¿å–ã‚Šã¯å…¨å“¡å¯èƒ½ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ä»–äººã® ideology/currentVote ã‚’è¡¨ç¤ºã—ãªã„ï¼‰
        // - æ›¸ãè¾¼ã¿ã¯æœ¬äººã®ã¿
        allow read: if isAuthenticated();
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }
    }
  }
}
